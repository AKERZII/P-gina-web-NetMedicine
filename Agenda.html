<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda de Citas | Red Médica</title>
  <link rel="stylesheet" href="Principal.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">

  <style>
    body { animation: fadeInPage 0.8s ease-in-out; }
    @keyframes fadeInPage { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    #calendar {
      max-width: 900px; margin: 50px auto; background: #fff; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px;
    }
  </style>
</head>

<body>

  <header class="top-header">
    <div class="logo"><img src="Logo.jpg" alt=""></div>
    <div class="contacto"><p>Tel: +52 (33) 1234 5678 | ✉ contacto@redmedica.mx</p></div>
    <div class="login" id="loginArea"><a href="login.html" class="btn-login">Iniciar Sesión</a></div>
  </header>

  <nav class="navbar">
    <ul class="menu">
      <li><a href="Principal.html">Inicio</a></li>
      <li><a href="Medicos.html">Médicos</a></li>
      <li><a href="Agenda.html">Agenda</a></li>
      <li><a href="Consultas.html">Consultas</a></li>
      <li><a href="Reportes.html">Reportes</a></li>
    </ul>
  </nav>

  <div id="calendar"></div>

  <div class="modal fade" id="citaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:12px;">
        <div class="modal-header">
          <h5 class="modal-title">Agendar cita</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>

        <div class="modal-body">
          <form id="formCita" class="needs-validation" method="POST" action="Registroagenda.php" novalidate>

            <input type="hidden" name="fecha" id="fechaInput">
            <input type="hidden" name="hora" id="horaInput">

            <div class="mb-3">
              <label class="form-label">Nombre</label>
              <input type="text" name="nombreInput" id="nombreInput" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Especialidad / Médico</label>
              <select name="medicoSelect" id="medicoSelect" class="form-select" required>
                <option value="">Selecciona...</option>
                <option>Cardiología - Dr. Juan García</option>
                <option>Pediatría - Dra. María López</option>
                <option>Dermatología - Dra. Ana Fernández</option>
                <option>Medicina General - Dr. Carlos Martínez</option>
                <option>Ginecología - Dra. Elena Rivas</option>
                <option>Psicología - Dr. Miguel Torres</option>
                <option>Endocrinología - Dra. Laura Navarro</option>
                <option>Medicina Interna - Dr. Roberto Hernández</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Correo</label>
              <input type="email" name="correoInput" id="correoInput" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Título</label>
              <input type="text" name="tituloInput" id="tituloInput" class="form-control" required>
            </div>

            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea name="descripcionInput" id="descripcionInput" class="form-control" required></textarea>
            </div>

            <div class="mb-3">
              <label class="form-label">Tipo</label>
              <select name="tipoSelect" id="tipoSelect" class="form-select" required>
                <option value="">Selecciona...</option>
                <option>Consulta</option>
                <option>Examen</option>
                <option>Urgencia</option>
              </select>
            </div>

            <button type="submit" class="btn btn-primary w-100">Confirmar cita</button>
          </form>
        </div>

      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {

      const calendar = new FullCalendar.Calendar(
        document.getElementById("calendar"), 
        {
          initialView: "dayGridMonth",
          dateClick(info) {
            document.getElementById("fechaInput").value = info.dateStr;
            const modal = new bootstrap.Modal(document.getElementById("citaModal"));
            modal.show();
          }
        }
      );

      calendar.render();
    });
   function mapearEventos() {
        return (JSON.parse(localStorage.getItem("citas")) || []).map((cita, idx) => ({
          id: idx.toString(),
          title: cita.titulo || cita.medico,
          start: `${cita.fecha}T${cita.hora}`,
          extendedProps: {
            nombre: cita.nombre,
            correo: cita.correo,
            medico: cita.medico,
            descripcion: cita.descripcion,
            tipo: cita.tipo
          }
        }));
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        validRange: { start: today },
        dateClick: function(info) {
          selectedDate = info.dateStr; // yyyy-mm-dd
          const citaModal = new bootstrap.Modal(document.getElementById('citaModal'));
          citaModal.show();
        },
        events: mapearEventos(),
        eventClick: function(info) {
          const usuarioActual = (localStorage.getItem("usuarioActual") || "").toLowerCase();
          const rolUsuario = (localStorage.getItem("rolUsuario") || "").toLowerCase();
          const esAdmin = rolUsuario === "admin" || usuarioActual === "admin";

          if (!esAdmin) {
            alert("⚠️ Solo el administrador puede eliminar citas.");
            return;
          }

          const nombre = info.event.extendedProps.nombre || "Paciente";
          const titulo = info.event.title || "Cita";
          if (confirm(`¿Eliminar la cita "${titulo}" de ${nombre}?`)) {
            const indice = parseInt(info.event.id, 10);
            let citasLS = JSON.parse(localStorage.getItem("citas")) || [];

            if (Number.isInteger(indice) && indice >= 0 && indice < citasLS.length) {
              // Eliminar del array persistido
              citasLS.splice(indice, 1);
              localStorage.setItem("citas", JSON.stringify(citasLS));
            }

            // Eliminar del calendario
            info.event.remove();

            // Reconstruir eventos con índices actualizados
            const nuevosEventos = mapearEventos();
            calendar.getEvents().forEach(e => e.remove());
            nuevosEventos.forEach(evt => calendar.addEvent(evt));

            alert("✅ Cita eliminada correctamente.");
          }
        }
      });

      calendar.render();

      // Referencias del formulario
      const form = document.getElementById('formCita');
      const nombreInput = document.getElementById('nombreInput');
      const medicoSelect = document.getElementById('medicoSelect');
      const horaInput = document.getElementById('horaInput');
      const correoInput = document.getElementById('correoInput');
      const tituloInput = document.getElementById('tituloInput');
      const descripcionInput = document.getElementById('descripcionInput');
      const tipoSelect = document.getElementById('tipoSelect');

      // Ajustar min y max del input de hora según el médico seleccionado
      medicoSelect.addEventListener('change', function() {
        const medico = medicoSelect.value;
        const horario = horariosDoctores[medico];
        if (horario) {
          horaInput.min = horario.inicio;
          horaInput.max = horario.fin;
        } else {
          horaInput.removeAttribute('min');
          horaInput.removeAttribute('max');
        }
      });

      // Validación y guardado de cita
      form.addEventListener('submit', function(event) {
        if (!form.checkValidity()) {
          event.preventDefault();
          event.stopPropagation();
          form.classList.add('was-validated');
          return;
        }
        event.preventDefault();

        if (!selectedDate) {
          alert("Selecciona un día en el calendario para agendar.");
          return;
        }

        const nombre = nombreInput.value.trim();
        const medico = medicoSelect.value;
        const hora = horaInput.value;
        const correo = correoInput.value.trim();
        const fecha = selectedDate;
        const titulo = tituloInput.value.trim();
        const descripcion = descripcionInput.value.trim();
        const tipo = tipoSelect.value;

        // Validación de horario (defensiva)
        const horario = horariosDoctores[medico];
        if (horario) {
          if (hora < horario.inicio || hora > horario.fin) {
            alert(`El horario de ${medico} es de ${horario.inicio} a ${horario.fin}. Selecciona una hora válida.`);
            return;
          }
        }

        let citasLS = JSON.parse(localStorage.getItem("citas")) || [];

        // Evitar duplicados (médico + fecha + hora)
        const existe = citasLS.some(c =>
          c.medico === medico && c.fecha === fecha && c.hora === hora
        );
        if (existe) {
          alert("Ya existe una cita con este médico en la misma fecha y hora.");
          return;
        }

        const nuevaCita = { nombre, medico, hora, correo, fecha, titulo, descripcion, tipo };
        citasLS.push(nuevaCita);
        localStorage.setItem("citas", JSON.stringify(citasLS));

        // Añadir al calendario con id basado en nuevo índice
        const nuevoId = (citasLS.length - 1).toString();
        calendar.addEvent({
          id: nuevoId,
          title: titulo || medico,
          start: `${fecha}T${hora}`,
          extendedProps: { nombre, correo, medico, descripcion, tipo }
        });

        alert("✅ Cita registrada correctamente.");
        form.reset();
        form.classList.remove('was-validated');
        bootstrap.Modal.getInstance(document.getElementById('citaModal')).hide();
      }, false);
    
  </script>

</body>
</html>
