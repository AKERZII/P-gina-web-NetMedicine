<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Agenda de Citas | Red Médica</title>
  <link rel="stylesheet" href="Principal.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    body { animation: fadeInPage 0.8s ease-in-out; }
    @keyframes fadeInPage { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    #calendar {
      max-width: 1000px; margin: 50px auto; background: #fff; border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08); padding: 20px;
    }
  </style>
</head>
<body>

  <!-- ENCABEZADO -->
  <header class="top-header">
    <div class="logo"><img src="img/Logo.jpg" alt="Logo"></div>
    <div class="contacto"><p>Tel: +52 (33) 1234 5678 | ✉ contacto@redmedica.mx</p></div>
    <div class="login" id="loginArea"><a href="login.html" class="btn-login">Iniciar Sesión</a></div>
    <script>
      const usuarioActual = localStorage.getItem("usuarioActual");
      const rolUsuario = localStorage.getItem("rolUsuario");
      if (usuarioActual) {
        document.getElementById("loginArea").innerHTML = `
          <p>Bienvenido, <strong>${usuarioActual}</strong> ${rolUsuario ? "(" + rolUsuario + ")" : ""}</p>
          <button id="logoutBtn" class="btn-login">Cerrar Sesión</button>
        `;
        document.getElementById("logoutBtn").addEventListener("click", () => {
          localStorage.removeItem("usuarioActual");
          localStorage.removeItem("rolUsuario");
          window.location.reload();
        });
      }
    </script>
  </header>

  <!-- NAVBAR -->
  <nav class="navbar">
    <ul class="menu">
      <li><a href="Principal.html">Inicio</a></li>
      <li><a href="Medicos.html">Médicos</a></li>
      <li><a href="Agenda.html">Agenda</a></li>
      <li><a href="Consultas.html">Consultas</a></li>
      <li class="dropdown">
        <a href="#">Servicios ▾</a>
        <ul class="submenu">
          <li><a href="Consultas.html">Consultas</a></li>
          <li><a href="Hospitalizacion.html">Hospitalización</a></li>
          <li><a href="Laboratorio.html">Laboratorio Clínico</a></li>
          <li><a href="Rehabilitacion.html">Rehabilitación</a></li>
          <li><a href="SaludMental.html">Salud Mental</a></li>
          <li><a href="Farmacia.html">Farmacia</a></li>
          <li><a href="Urgencias.html">Urgencias</a></li>
          <li><a href="Planificacion.html">Planificación Familiar</a></li>
        </ul>
      </li>
      <li><a href="Reportes.html">Reportes</a></li>
    </ul>
  </nav>

  <!-- CALENDARIO -->
  <div id="calendar"></div>

  <!-- MODAL PARA AGENDAR -->
  <div class="modal fade" id="citaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content" style="border-radius:12px;">
        <div class="modal-header">
          <h5 class="modal-title">Agendar cita</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <form id="formCita" class="needs-validation" novalidate>
            <input type="hidden" id="fechaInput">
            <div class="mb-3">
              <label class="form-label">Nombre del paciente</label>
              <input type="text" id="nombreInput" class="form-control" required>
              <div class="invalid-feedback">Por favor ingresa el nombre del paciente.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Especialidad / Médico</label>
              <input type="text" id="medicoInput" class="form-control" required>
              <div class="invalid-feedback">Ingresa el médico o la especialidad.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Hora</label>
              <input type="time" id="horaInput" class="form-control" required>
              <div class="invalid-feedback">Selecciona una hora válida.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Correo electrónico</label>
              <input type="email" id="correoInput" class="form-control" required>
              <div class="invalid-feedback">Ingresa un correo válido.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Título de la cita</label>
              <input type="text" id="tituloInput" class="form-control" required>
              <div class="invalid-feedback">Ingresa un título para la cita.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Descripción</label>
              <textarea id="descripcionInput" class="form-control" rows="3" required></textarea>
              <div class="invalid-feedback">Agrega una breve descripción.</div>
            </div>
            <div class="mb-3">
              <label class="form-label">Tipo de cita</label>
              <select id="tipoSelect" class="form-select" required>
                <option value="">Selecciona...</option>
                <option>Consulta</option>
                <option>Examen</option>
                <option>Urgencia</option>
              </select>
              <div class="invalid-feedback">Selecciona el tipo de cita.</div>
            </div>
            <button type="submit" class="btn btn-primary w-100">Confirmar cita</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- SCRIPTS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const calendarEl = document.getElementById('calendar');
      const modalEl = document.getElementById('citaModal');
      const modal = new bootstrap.Modal(modalEl);
      const today = new Date().toISOString().split('T')[0];

      // Utilidades de almacenamiento
      function getCitas(){ return JSON.parse(localStorage.getItem("citas")) || []; }
      function setCitas(citas){ localStorage.setItem("citas", JSON.stringify(citas)); }

      function mapearEventos() {
        return getCitas().map((cita, idx) => ({
          id: cita.id || idx.toString(),
          title: cita.titulo || cita.medico,
          start: `${cita.fecha}T${cita.hora}`,
          extendedProps: {
            nombre: cita.nombre,
            correo: cita.correo,
            medico: cita.medico,
            descripcion: cita.descripcion,
            tipo: cita.tipo
          }
        }));
      }

      // Inicialización del calendario
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'es',
        selectable: true,
        navLinks: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        buttonText: {
          today: 'Hoy',
          month: 'Mes',
          week: 'Semana',
          day: 'Día'
        },
        validRange: { start: today }, // Bloquea días anteriores
        dateClick: function(info) {
          const fechaSel = info.dateStr;
          if (fechaSel < today) {
            alert("No puedes agendar en días anteriores al de hoy.");
            return;
          }
          document.getElementById('fechaInput').value = fechaSel;
          const form = document.getElementById('formCita');
          form.reset();
          form.classList.remove('was-validated');
          modal.show();
        },
        events: mapearEventos(),
        eventClick: function(info) {
          const evento = info.event;
          const props = evento.extendedProps;
          const rol = localStorage.getItem("rolUsuario");

          const resumen = `
Cita: ${evento.title}
Fecha: ${evento.startStr}
Paciente: ${props.nombre}
Correo: ${props.correo}
Médico: ${props.medico}
Tipo: ${props.tipo}
Descripción: ${props.descripcion}
          `.trim();

          if (rol === 'admin') {
            if (confirm(resumen + "\n\n¿Deseas eliminar esta cita?")) {
              const citas = getCitas().filter(c => (c.id || '') !== evento.id);
              setCitas(citas);
              calendar.refetchEvents();
              alert("Cita eliminada correctamente.");
            }
          } else {
            alert(resumen);
          }
        }
      });

      calendar.render();

      // Guardado de la cita (bloqueo de fechas anteriores)
      const form = document.getElementById('formCita');
      form.addEventListener('submit', function(e){
        if (!form.checkValidity()) {
          e.preventDefault();
          e.stopPropagation();
          form.classList.add('was-validated');
          return;
        }
        e.preventDefault();

        const fecha = document.getElementById('fechaInput').value;
        const nombre = document.getElementById('nombreInput').value.trim();
        const medico = document.getElementById('medicoInput').value.trim();
        const hora = document.getElementById('horaInput').value;
        const correo = document.getElementById('correoInput').value.trim();
        const titulo = document.getElementById('tituloInput').value.trim();
        const descripcion = document.getElementById('descripcionInput').value.trim();
        const tipo = document.getElementById('tipoSelect').value;

        const hoy = new Date().toISOString().split('T')[0];
        if (!fecha || fecha < hoy) {
          alert("No puedes agendar en días anteriores al de hoy.");
          return;
        }

        const nueva = {
          id: 'c_' + Math.random().toString(36).slice(2, 10),
          nombre, medico, hora, correo, titulo, descripcion, tipo, fecha
        };

        const citas = getCitas();
        citas.push(nueva);
        setCitas(citas);
        modal.hide();
        calendar.refetchEvents();
        alert("Cita agendada correctamente.");
      });
    });
  </script>
</body>
</html>
